//@version=5
indicator("Midnight Bias ‚Üí Telegram Alert + TP/SL + Ticker/Side (05‚Äì07 NYT)", overlay=true)

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
testMode = input.bool(false, "Test mode: send test setup on last bar")
tpPerc   = input.float(1.5,   "Take Profit %", step=0.1)
slPerc   = input.float(0.5,   "Stop Loss %",   step=0.1)

// –¢–∞–π–º—Å—Ç–µ–º–ø—ã NY Time
f_ts(h, m) => timestamp("America/New_York", year, month, dayofmonth, h, m)
midnight   = f_ts(0,0)
rangeStart = f_ts(5,0)
rangeEnd   = f_ts(7,0)

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
var float midPrice  = na
var int   totalBars = 0
var int   aboveBars = 0
var bool  signaled  = false

// 1) –í 00:00 —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ü–µ–Ω—É –æ—Ç–∫—Ä—ã—Ç–∏—è –∏ –æ–±–Ω—É–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
if time >= midnight and time[1] < midnight
    midPrice  := open
    totalBars := 0
    aboveBars := 0
    signaled  := false

// 2) –°—á–∏—Ç–∞–µ–º –±–∞—Ä—ã 05:00‚Äì07:00
if time >= rangeStart and time < rangeEnd
    totalBars += 1
    if close > midPrice
        aboveBars += 1

// 3) –ù–∞ –ø–µ—Ä–≤–æ–º –±–∞—Ä–µ ‚â•07:00 –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ
longSignal = false
if time >= rangeEnd and time[1] < rangeEnd and not signaled
    if totalBars > 0 and aboveBars / totalBars > 0.5
        longSignal := true
    signaled := true

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ setup-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
sendSetup(side) =>
    tpPrice = midPrice * (1 + tpPerc/100)
    slPrice = midPrice * (1 - slPerc/100)
    // —Å–æ–±–∏—Ä–∞–µ–º JSON —Å HTML-—Ä–∞–∑–º–µ—Ç–∫–æ–π
    payload = "{\"chat_id\":\"-1002162702173\",\"parse_mode\":\"HTML\",\"text\":\"" +
      "<b>üìä SETUP</b>\\n" +
      "–°–∏–º–≤–æ–ª: <code>" + syminfo.ticker + "</code>\\n" +
      "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>" + side + "</b>\\n" +
      "Entry: <code>" + str.tostring(midPrice, format.mintick) + "</code>\\n" +
      "TP:    <code>" + str.tostring(tpPrice,   format.mintick) + "</code>\\n" +
      "SL:    <code>" + str.tostring(slPrice,   format.mintick) + "</code>\\n" +
      '<b>‚ö†Ô∏è Risk Reminder:</b> Always cap your loss to <b>1% of your account</b> per trade to protect your capital.' +
      '"}'
    alert(payload, alert.freq_once_per_bar_close)

// 4) –ü—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —Å–∏–≥–Ω–∞–ª–µ —à–ª—ë–º Long-setup
if longSignal
    sendSetup("Long")

// 5) –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º —Ç–æ–∂–µ —à–ª—ë—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–µ—Ç–∞–ø
if testMode and barstate.islast
    sendSetup("TEST")

// 6) –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
plotshape(longSignal, title="LONG", style=shape.labelup,
     location=location.belowbar, text="LONG", textcolor=color.white,
     size=size.small, color=color.green)
plotshape(testMode and barstate.islast, title="TEST", style=shape.labelup,
     location=location.belowbar, text="TEST", textcolor=color.white,
     size=size.small, color=color.orange)
